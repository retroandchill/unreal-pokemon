#nullable enable
using static UnrealSharp.Interop.FTypeBuilderExporter;
using static UnrealSharp.Interop.FPropertyExporter;
using static UnrealSharp.Interop.UClassExporter;
using static UnrealSharp.Interop.UFunctionExporter;

using UnrealSharp;
using UnrealSharp.Core;
using UnrealSharp.Attributes;
using UnrealSharp.RPGCore;
using UnrealSharp.RPGSaving;
using System.Runtime.CompilerServices;

namespace {{Namespace}};

partial class {{ClassName}}
{
    protected override bool Supports_Implementation(TSubclassOf<URPGComponent> componentClass)
    {
        return componentClass.IsChildOf(typeof({{ComponentType}}));
    }

    protected override void SaveData_Implementation(URPGComponent component, FRPGComponentSaveDataHandle saveData)
    {
        if (component is not {{ComponentType}} castComponent)
        {
            {{#WithLogging}}
            {{LoggerClass}}.LogError($"Trying to save {component.GetType()} as {typeof({{ComponentType}})}");
            {{/WithLogging}}
            return;
        }

        try 
        {
            saveData.SetData({{SaveMethod}}(castComponent));
        }
        catch (Exception e)
        {
            {{#WithLogging}}
            {{LoggerClass}}.LogError($"Unexpected error trying to save {component.ObjectName}: {e}");
            {{/WithLogging}}
        }
    }

    protected override void LoadData_Implementation(URPGComponent component, FRPGComponentSaveDataHandle saveData)
    {
        if (component is not {{ComponentType}} castComponent)
        {   
            {{#WithLogging}}
            {{LoggerClass}}.LogError($"Trying to load {component.GetType()} as {typeof({{ComponentType}})}");
            {{/WithLogging}}
            return;
        }

        if (!saveData.TryGetData(out {{ModelType}} data))
        {
            {{#WithLogging}}
            {{LoggerClass}}.LogError($"Tried to load {saveData.SaveDataStruct?.ObjectName ?? "null"} as {typeof({{ModelType}})}");
            {{/WithLogging}}
            return;
        }

        try
        {
            {{LoadMethod}}({{#ModelFirst}}data, castComponent{{/ModelFirst}}{{^ModelFirst}}castComponent, data{{/ModelFirst}});
        }
        catch (Exception e)
        {
            {{#WithLogging}}
            {{LoggerClass}}.LogError($"Unexpected error trying to save {component.ObjectName}: {e}");
            {{/WithLogging}}
        }
    }
}
    
internal static class {{ClassName}}_AdditionalOverrides_Initializer
{
    #pragma warning disable CA2255
    [ModuleInitializer]
    #pragma warning restore CA2255
    public static void Register() => StartUpJobManager.RegisterTypeAdditionalBuildJob("{{EngineName}}", Initialize);

    private static void Initialize(IntPtr nativeType)
    {
        NewOverride(nativeType, "K2_Supports");
        NewOverride(nativeType, "K2_SaveData");
        NewOverride(nativeType, "K2_LoadData");
    }

}